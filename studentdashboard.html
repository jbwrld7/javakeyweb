<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard</title>
    <link rel="icon" type="image/x-icon" href="javakeylogo.png">
    <link rel="stylesheet" href="studentdashboard.css">

<style>
  .leaderboard-container {
    background: #1e1e1e;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    color: white;
  }

  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #333;
  }

  th {
    background-color: #0ea400;
    color: #121212;
    font-size: 16px;
  }

  tr:hover {
    background-color: #252525;
  }

  .stage-header {
    background: #0ea400;
    color: #121212;
    font-size: 18px;
    font-weight: bold;
    padding: 12px;
    text-align: left;
  }

  h3 {
    color: #0ea400;
    margin-bottom: 10px;
  }

  #loading {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #121212;
    color: white;
    z-index: 2000;
    font-size: 1.2rem;
  }
</style>

  </head>

<body>
  <div id="loading">Checking session...</div>

  <div class="sidebar" id="sidebar">
    <button class="close-btn" id="closeBtn">X</button>
    <img src="javakeylogo.png" alt="JavaKey Logo" class="logo">
    <a href="studentdashboard.html">Dashboard</a>
    <a href="progress.html">Progress</a>
    <a href="settings.html">Settings</a>
    <a href="#" id="logout">Logout</a>
  </div>

  <div class="main-content">
    <div class="header">
      <div style="display: flex; align-items: center;">
        <button class="menu-toggle" id="menuToggle">â˜°</button>
        <h2>Dashboard</h2>
      </div>
      <div class="user-info">Welcome, <span id="username">Loading...</span></div>
    </div>

    <div class="dashboard">
      <div class="card">

        <h3>Leaderboards</h3>

        <div class="leaderboard-container">
          <table id="leaderboardTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Full Name</th>
                <th>Section</th>
                <th>Stage Name</th>
                <th>Best Time (min:sec)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <footer>&copy; 2025 JavaKey | All Rights Reserved</footer>

<script type="module">

  import { auth } from "./firebaseconfig.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
  import {
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
  import { checkSession } from "./authcheck.js";

  const db = getFirestore();
  const loading = document.getElementById("loading");
  const usernameDisplay = document.getElementById("username");
  const tableBody = document.querySelector("#leaderboardTable tbody");

  let currentUserName = "";

  checkSession().then(() => {
    loading.style.display = "none";
  });

  // =========================================
  // LOAD LEADERBOARD GROUPED PER STAGE
  // =========================================
  async function loadLeaderboard() {
    try {
      const usersSnap = await getDocs(collection(db, "users"));
      let stageGroups = {}; // <-- store users grouped per stage

      for (const userDoc of usersSnap.docs) {
        const userData = userDoc.data();
        const stageTimesRef = collection(db, "users", userDoc.id, "stageTimes");
        const stageTimesSnap = await getDocs(stageTimesRef);

        stageTimesSnap.forEach(stageDoc => {
          const data = stageDoc.data();
          const stageName = data.stage || stageDoc.id;
          const bestTime = data.bestTime;

          if (!bestTime) return;

          if (!stageGroups[stageName]) {
            stageGroups[stageName] = [];
          }

          stageGroups[stageName].push({
            fullname: userData.fullname || "No Name",
            section: userData.section || "N/A",
            stage: stageName,
            bestTime
          });
        });
      }

      tableBody.innerHTML = "";

      // LOOP THROUGH ALL STAGES
      for (const stageName in stageGroups) {

        // Sort per stage by fastest time
        stageGroups[stageName].sort((a, b) => a.bestTime - b.bestTime);

        // Stage Header Row
        tableBody.innerHTML += `
          <tr class="stage-header">
            <td colspan="5">${stageName}</td>
          </tr>
        `;

        // Student Rows in this Stage
        stageGroups[stageName].forEach((user, index) => {
          const mins = Math.floor(user.bestTime / 60);
          const secs = String(Math.floor(user.bestTime % 60)).padStart(2, "0");

          tableBody.innerHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${user.fullname}</td>
              <td>${user.section}</td>
              <td>${user.stage}</td>
              <td>${mins}:${secs}</td>
            </tr>
          `;
        });
      }

    } catch (err) {
      console.error("Leaderboard Error:", err);
      tableBody.innerHTML = `<tr><td colspan="5">Failed to load leaderboard.</td></tr>`;
    }
  }

  // AUTH
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);

      if (docSnap.exists()) {
        currentUserName = docSnap.data().fullname || "Student";
        usernameDisplay.textContent = currentUserName;
      }

      await loadLeaderboard();
    } else {
      usernameDisplay.textContent = "Guest";
      tableBody.innerHTML =
        `<tr><td colspan="5">Please log in to view the leaderboard.</td></tr>`;
    }
  });

  // LOGOUT
  document.getElementById("logout").addEventListener("click", async (e) => {
    e.preventDefault();
    await signOut(auth);
    alert("Logged out successfully!");
    window.location.href = "index.html";
  });

  // SIDEBAR
  const sidebar = document.getElementById("sidebar");
  document.getElementById("menuToggle").addEventListener("click", () => {
    sidebar.classList.add("show");
  });
  document.getElementById("closeBtn").addEventListener("click", () => {
    sidebar.classList.remove("show");
  });

</script>

</body>
</html>
